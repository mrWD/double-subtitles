const BROWSER_SVG = '<svg height="200px" width="200px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" xml:space="preserve" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g transform="translate(1 1)"> <g> <path style="fill:#FFE100;" d="M323.267,7.533H24.6c-9.387,0-17.067,7.68-17.067,17.067v85.333h315.733V7.533z"></path> <path style="fill:#FFE100;" d="M485.4,7.533h-59.733v102.4h76.8V24.6C502.467,15.213,494.787,7.533,485.4,7.533"></path> <path style="fill:#FFE100;" d="M425.667,109.933V306.2l-51.2-51.2l-51.2,51.2V109.933H7.533V485.4 c0,9.387,7.68,17.067,17.067,17.067h460.8c9.387,0,17.067-7.68,17.067-17.067V109.933H425.667z"></path> </g> <g> <path style="fill:#FFA800;" d="M485.4,7.533h-25.6c9.387,0,17.067,7.68,17.067,17.067v85.333h25.6V24.6 C502.467,15.213,494.787,7.533,485.4,7.533"></path> <path style="fill:#FFA800;" d="M476.867,109.933V485.4c0,9.387-7.68,17.067-17.067,17.067h25.6c9.387,0,17.067-7.68,17.067-17.067 V109.933H476.867z"></path> </g> <g> <path style="fill:#FFFFFF;" d="M24.6,7.533h25.6c-9.387,0-17.067,7.68-17.067,17.067v85.333h-25.6V24.6 C7.533,15.213,15.213,7.533,24.6,7.533"></path> <path style="fill:#FFFFFF;" d="M33.133,109.933V485.4c0,9.387,7.68,17.067,17.067,17.067H24.6c-9.387,0-17.067-7.68-17.067-17.067 V109.933H33.133z"></path> </g> <g> <polygon style="fill:#00DA6C;" points="425.667,306.2 374.467,255 323.267,306.2 323.267,7.533 425.667,7.533 "></polygon> <path style="fill:#00DA6C;" d="M92.867,58.733c0-14.507-11.093-25.6-25.6-25.6s-25.6,11.093-25.6,25.6s11.093,25.6,25.6,25.6 S92.867,73.24,92.867,58.733"></path> <path style="fill:#00DA6C;" d="M178.2,58.733c0-14.507-11.093-25.6-25.6-25.6c-14.507,0-25.6,11.093-25.6,25.6 s11.093,25.6,25.6,25.6C167.107,84.333,178.2,73.24,178.2,58.733"></path> <path style="fill:#00DA6C;" d="M263.533,58.733c0-14.507-11.093-25.6-25.6-25.6c-14.507,0-25.6,11.093-25.6,25.6 s11.093,25.6,25.6,25.6C252.44,84.333,263.533,73.24,263.533,58.733"></path> </g> <path style="fill:#63D3FD;" d="M255,442.733v-153.6c0-9.387-7.68-17.067-17.067-17.067h-153.6c-9.387,0-17.067,7.68-17.067,17.067 v51.2l-25.6,25.6l25.6,25.6v51.2c0,9.387,7.68,17.067,17.067,17.067h153.6C247.32,459.8,255,452.12,255,442.733"></path> <path d="M67.267,92.867c-18.773,0-34.133-15.36-34.133-34.133S48.493,24.6,67.267,24.6S101.4,39.96,101.4,58.733 S86.04,92.867,67.267,92.867z M67.267,41.667c-9.387,0-17.067,7.68-17.067,17.067S57.88,75.8,67.267,75.8 s17.067-7.68,17.067-17.067S76.653,41.667,67.267,41.667z"></path> <path d="M152.6,92.867c-18.773,0-34.133-15.36-34.133-34.133S133.827,24.6,152.6,24.6s34.133,15.36,34.133,34.133 S171.373,92.867,152.6,92.867z M152.6,41.667c-9.387,0-17.067,7.68-17.067,17.067S143.213,75.8,152.6,75.8 s17.067-7.68,17.067-17.067S161.987,41.667,152.6,41.667z"></path> <path d="M237.933,92.867c-18.773,0-34.133-15.36-34.133-34.133S219.16,24.6,237.933,24.6s34.133,15.36,34.133,34.133 S256.707,92.867,237.933,92.867z M237.933,41.667c-9.387,0-17.067,7.68-17.067,17.067s7.68,17.067,17.067,17.067 S255,68.12,255,58.733S247.32,41.667,237.933,41.667z"></path> <path d="M417.133,365.933h-93.867c-5.12,0-8.533-3.413-8.533-8.533s3.413-8.533,8.533-8.533h93.867c5.12,0,8.533,3.413,8.533,8.533 S422.253,365.933,417.133,365.933z"></path> <path d="M417.133,468.333h-93.867c-5.12,0-8.533-3.413-8.533-8.533s3.413-8.533,8.533-8.533h93.867c5.12,0,8.533,3.413,8.533,8.533 S422.253,468.333,417.133,468.333z"></path> <path d="M459.8,417.133H348.867c-5.12,0-8.533-3.413-8.533-8.533c0-5.12,3.413-8.533,8.533-8.533H459.8 c5.12,0,8.533,3.413,8.533,8.533C468.333,413.72,464.92,417.133,459.8,417.133z"></path> <path d="M212.333,220.867H75.8c-5.12,0-8.533-3.413-8.533-8.533c0-5.12,3.413-8.533,8.533-8.533h136.533 c5.12,0,8.533,3.413,8.533,8.533C220.867,217.453,217.453,220.867,212.333,220.867z"></path> <path d="M255,169.667H101.4c-5.12,0-8.533-3.413-8.533-8.533c0-5.12,3.413-8.533,8.533-8.533H255c5.12,0,8.533,3.413,8.533,8.533 C263.533,166.253,260.12,169.667,255,169.667z"></path> <path d="M237.933,468.333h-153.6c-14.507,0-25.6-11.093-25.6-25.6v-47.787l-23.04-23.04c-3.413-3.413-3.413-8.533,0-11.947 l23.04-23.04v-47.787c0-14.507,11.093-25.6,25.6-25.6h153.6c14.507,0,25.6,11.093,25.6,25.6v153.6 C263.533,457.24,252.44,468.333,237.933,468.333z M53.613,365.933L73.24,385.56c1.707,1.707,2.56,3.413,2.56,5.973v51.2 c0,5.12,3.413,8.533,8.533,8.533h153.6c5.12,0,8.533-3.413,8.533-8.533v-153.6c0-5.12-3.413-8.533-8.533-8.533h-153.6 c-5.12,0-8.533,3.413-8.533,8.533v51.2c0,2.56-0.853,4.267-2.56,5.973L53.613,365.933z"></path> <path d="M135.533,425.667c-14.507,0-25.6-11.093-25.6-25.6v-13.653l-14.507-14.507c-1.707-1.707-2.56-4.267-2.56-5.973 c0-2.56,0.853-4.267,2.56-5.973l14.507-14.507V331.8c0-14.507,11.093-25.6,25.6-25.6c5.12,0,8.533,3.413,8.533,8.533 c0,5.12-3.413,8.533-8.533,8.533c-4.267,0-8.533,4.267-8.533,8.533v17.067c0,2.56-0.853,4.267-2.56,5.973l-11.093,11.093 l11.093,11.093c1.707,1.707,2.56,3.413,2.56,5.973v17.067c0,4.267,4.267,8.533,8.533,8.533c5.12,0,8.533,3.413,8.533,8.533 S140.653,425.667,135.533,425.667z"></path> <path d="M186.733,425.667c-5.12,0-8.533-3.413-8.533-8.533s3.413-8.533,8.533-8.533c4.267,0,8.533-4.267,8.533-8.533V383 c0-2.56,0.853-4.267,2.56-5.973l11.093-11.093l-11.093-11.093c-1.707-1.707-2.56-3.413-2.56-5.973V331.8 c0-4.267-4.267-8.533-8.533-8.533c-5.12,0-8.533-3.413-8.533-8.533c0-5.12,3.413-8.533,8.533-8.533c14.507,0,25.6,11.093,25.6,25.6 v13.653l14.507,14.507c3.413,3.413,3.413,8.533,0,11.947l-14.507,14.507v13.653C212.333,414.573,201.24,425.667,186.733,425.667z"></path> <path d="M425.667,314.733c-2.56,0-4.267-0.853-5.973-2.56l-45.227-45.227l-45.227,45.227c-2.56,2.56-5.973,3.413-9.387,1.707 c-3.413-0.853-5.12-4.267-5.12-7.68V7.533c0-5.12,3.413-8.533,8.533-8.533h102.4c5.12,0,8.533,3.413,8.533,8.533V306.2 c0,3.413-1.707,6.827-5.12,7.68C428.227,314.733,426.52,314.733,425.667,314.733z M374.467,246.467c2.56,0,4.267,0.853,5.973,2.56 l36.693,36.693V16.067H331.8V285.72l36.693-36.693C370.2,247.32,371.907,246.467,374.467,246.467z"></path> <path d="M323.267,118.467H7.533c-5.12,0-8.533-3.413-8.533-8.533V24.6C-1,10.093,10.093-1,24.6-1h298.667 c5.12,0,8.533,3.413,8.533,8.533v102.4C331.8,115.053,328.387,118.467,323.267,118.467z M16.067,101.4h298.667V16.067H24.6 c-5.12,0-8.533,3.413-8.533,8.533V101.4z"></path> <path d="M502.467,118.467h-76.8c-5.12,0-8.533-3.413-8.533-8.533V7.533c0-5.12,3.413-8.533,8.533-8.533H485.4 C499.907-1,511,10.093,511,24.6v85.333C511,115.053,507.587,118.467,502.467,118.467z M434.2,101.4h59.733V24.6 c0-5.12-3.413-8.533-8.533-8.533h-51.2V101.4z"></path> <path d="M485.4,511H24.6C10.093,511-1,499.907-1,485.4V109.933c0-5.12,3.413-8.533,8.533-8.533h315.733 c5.12,0,8.533,3.413,8.533,8.533V285.72l36.693-36.693c3.413-3.413,8.533-3.413,11.947,0l36.693,36.693V109.933 c0-5.12,3.413-8.533,8.533-8.533h76.8c5.12,0,8.533,3.413,8.533,8.533V485.4C511,499.907,499.907,511,485.4,511z M16.067,118.467 V485.4c0,5.12,3.413,8.533,8.533,8.533h460.8c5.12,0,8.533-3.413,8.533-8.533V118.467H434.2V306.2c0,3.413-1.707,6.827-5.12,7.68 c-3.413,1.707-6.827,0.853-9.387-1.707l-45.227-45.227l-45.227,45.227c-2.56,2.56-5.973,3.413-9.387,1.707 c-3.413-0.853-5.12-4.267-5.12-7.68V118.467H16.067z"></path> </g> </g></svg>';
const QUIZLET_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path d="m25.3943 2.5455a21.1471 21.1471 0 0 0 -17.4149 7.3184 21.35 21.35 0 0 0 7.0043 33.2406 21.11 21.11 0 0 0 18.872-.4063.5875.5875 0 0 1 .3-.0638.5817.5817 0 0 1 .2913.0964 16.376 16.376 0 0 0 9.3119 2.7683.5932.5932 0 0 0 .5934-.5949v-7.2342a.5975.5975 0 0 0 -.1369-.3886.5863.5863 0 0 0 -.3553-.2063 8.395 8.395 0 0 1 -1.9819-.5711.5891.5891 0 0 1 -.3273-.3753.6173.6173 0 0 1 -.0177-.2551.6033.6033 0 0 1 .0892-.2389 21.3658 21.3658 0 0 0 -5.8561-29.5607 21.1237 21.1237 0 0 0 -10.3963-3.5413zm-14.217 21.273a12.9087 12.9087 0 0 1 7.9188-11.9366 12.7967 12.7967 0 0 1 14.0012 2.7921 12.9438 12.9438 0 0 1 -1.949 19.865 12.8043 12.8043 0 0 1 -16.2137-1.6038 12.9421 12.9421 0 0 1 -3.7661-9.1179z" fill="#4355ff" stroke="#4355ff" stroke-linecap="round" stroke-linejoin="round"/></svg>`
const ANKIAPP_SVG = `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="48pt" viewBox="0 0 48 48" width="48pt"><linearGradient id="a" gradientTransform="matrix(49.077 0 0 49.651 -1.017 -.909)" gradientUnits="userSpaceOnUse" x1="0" x2=".907488" y1=".5" y2=".920078"><stop offset="0" stop-color="#00c4ff"/><stop offset=".83888397938" stop-color="#0072ff"/></linearGradient><path d="m20.509 12.697c-.278 1.259-1.528 2.061-2.79 1.79-1.263-.271-2.062-1.519-1.785-2.784l1.484-6.893c.679-3.156 3.085-3.866 5.369-1.584l8.169 8.161 11.273-.91c3.218-.26 4.655 1.872 3.207 4.757l-4.934 9.829 3.826 9.915c1.162 3.012-.481 5.038-3.668 4.521l-11.318-1.836-8.939 7.36c-2.492 2.053-4.829 1.117-5.216-2.088l-1.3-10.771-9.97-6.346c-2.723-1.734-2.521-4.163.452-5.422l8.184-3.464c1.189-.503 2.562.052 3.066 1.24.503 1.188-.052 2.562-1.241 3.066l-5.369 2.281 9.254 5.884 1.24 10.296 8.505-6.996 11.126 1.801-3.744-9.698 4.761-9.465-10.973.889-7.768-7.756z" fill="url(#a)"/></svg>`
const GSHEETS_SVG = `<svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="100" height="100" viewBox="0 0 48 48"><path fill="#43a047" d="M37,45H11c-1.657,0-3-1.343-3-3V6c0-1.657,1.343-3,3-3h19l10,10v29C40,43.657,38.657,45,37,45z"></path><path fill="#c8e6c9" d="M40 13L30 13 30 3z"></path><path fill="#2e7d32" d="M30 13L40 23 40 13z"></path><path fill="#e8f5e9" d="M31,23H17h-2v2v2v2v2v2v2v2h18v-2v-2v-2v-2v-2v-2v-2H31z M17,25h4v2h-4V25z M17,29h4v2h-4V29z M17,33h4v2h-4V33z M31,35h-8v-2h8V35z M31,31h-8v-2h8V31z M31,27h-8v-2h8V27z"></path></svg>`;

const BROWSER_CHECKBOX = 'browser-check';
const ANKIAPP_CHECKBOX = 'ankiapp-check';
const QUIZLET_CHECKBOX = 'quizlet-check';
const GSHEETS_CHECKBOX = 'gsheets-check';

const ANKIAPP_INPUT = 'ankiDeckName';
const QUIZLET_INPUT = 'quizletDeckName';
const GSHEETS_INPUT = 'gSheetSpreadsheetId';
const GSHEETS_RANGE = 'gSheetRangeName';

function openMenu({ text, translation }) {
  const menu = createMenu();

  const textInput = document.querySelector('#text-input');
  const translationInput = document.querySelector('#translation-input');

  textInput.value = text;
  translationInput.value = translation;

  menu.classList.toggle('visible');
}

function createMenu() {
  const existedMenu = document.querySelector('#menu');

  if (existedMenu) {
    return existedMenu;
  }

  const menu = document.createElement('div');
  const btnGroup = document.createElement('div');

  menu.classList.add('menu');
  menu.setAttribute('id', 'menu');

  menu.appendChild(createInput('text-input'));
  menu.appendChild(createInput('translation-input'));

  menu.appendChild(createServiceCheckbox(BROWSER_CHECKBOX, BROWSER_SVG, 'Browser'));

  menu.appendChild(createServiceCheckbox(ANKIAPP_CHECKBOX, ANKIAPP_SVG, 'Anki'));
  menu.appendChild(createServiceForm(ANKIAPP_INPUT));

  menu.appendChild(createServiceCheckbox(QUIZLET_CHECKBOX, QUIZLET_SVG, 'Quizlet'));
  menu.appendChild(createServiceForm(QUIZLET_INPUT));

  menu.appendChild(createServiceCheckbox(GSHEETS_CHECKBOX, GSHEETS_SVG, 'Google Sheet'));
  menu.appendChild(createServiceForm(GSHEETS_INPUT, GSHEETS_RANGE));

  btnGroup.classList.add('btnGroup');
  btnGroup.appendChild(createCancelButton());
  btnGroup.appendChild(createSaveButton());

  menu.appendChild(btnGroup);

  document.body.appendChild(menu);

  return menu;
}

function createCancelButton() {
  const cancelButton = document.createElement('button');

  cancelButton.classList.add('cancelButton');
  cancelButton.textContent = 'Cancel';

  cancelButton.addEventListener('click', () => {
    const menu = document.querySelector('#menu');
    menu.classList.remove('visible');
  });

  return cancelButton;
}

function createSaveButton() {
  const saveButton = document.createElement('button');

  saveButton.classList.add('saveButton');
  saveButton.textContent = 'Save';

  saveButton.addEventListener('click', () => {
    const menu = document.querySelector('#menu');
    const textInput = document.querySelector('#text-input');
    const translationInput = document.querySelector('#translation-input');

    saveCards({
      text: textInput.value,
      translation: translationInput.value,
    });

    menu.classList.remove('visible');
  });

  return saveButton;
}

function createInput(name) {
  const input = document.createElement('textarea');

  input.classList.add('serviceInput');

  input.setAttribute('id', name);
  input.setAttribute('name', name);
  input.setAttribute('type', 'text');

  return input;
}

function createServiceCheckbox(id, svg, name) {
  const checkbox = `<input class="saveCheckbox" type="checkbox" value="${id}" checked>`;
  const saveButton = document.createElement('label');

  saveButton.classList.add('serviceCheckbox');
  saveButton.innerHTML = checkbox + svg + `<span>${name}</span>`;

  return saveButton;
}

function saveCards({ text, translation }) {
  const checkboxes = document.querySelectorAll('.saveCheckbox');
  const mapCheckBoxToService = {
    [BROWSER_CHECKBOX]: () => {
      saveToSyncStorage({ text, translation });
    },
    [ANKIAPP_CHECKBOX]: () => {
      const deckName = document.getElementById(ANKIAPP_INPUT).value;
      saveToAnki({ deckName, text, translation });
    },
    [QUIZLET_CHECKBOX]: () => {
      const deckName = document.getElementById(QUIZLET_INPUT).value;
      saveToQuizlet({ deckName, text, translation });
    },
    [GSHEETS_CHECKBOX]: () => {
      const spreadsheetId = document.getElementById(GSHEETS_INPUT).value;
      const rangeName = document.getElementById(GSHEETS_RANGE).value;
      saveToGSheet({ spreadsheetId, rangeName, text, translation });
    },
  };

  Array.from(checkboxes).forEach(checkbox => {
    if (checkbox.checked) {
      mapCheckBoxToService[checkbox.value]();
    }
  });
}

function createServiceForm(...fields) {
  const div = document.createElement('div');

  div.classList.add('serviceForm');

  fields.forEach(field => {
    const input = document.createElement('input');

    input.setAttribute('id', field);
    input.setAttribute('name', field);
    input.setAttribute('type', 'text');
    input.setAttribute('placeholder', field);

    input.addEventListener('keypress', (e) => {
      if (e.key !== 'Tab') {
        e.stopPropagation();
      }
    });

    input.addEventListener('keydown', (e) => {
      if (e.key !== 'Tab') {
        e.stopPropagation();
      }
    });

    input.addEventListener('keyup', (e) => {
      if (e.key !== 'Tab') {
        e.stopPropagation();
      }
    });

    div.appendChild(input);
  });

  return div;
}
